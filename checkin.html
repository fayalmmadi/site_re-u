<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Enregistrement du passager</title>

  <style>
    :root {
      --bg:#f8f9fa; --ink:#1f2937; --muted:#6b7280;
      --card:#fff; --ok:#16a34a; --warn:#d97706; --err:#dc2626;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:40px 16px; background:var(--bg);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--ink); text-align:center;
    }
    h1{margin:0; font-size:26px}
    #message{margin-top:8px; color:var(--muted)}
    .recu{
      max-width:520px; margin:28px auto; text-align:left;
      background:var(--card); border-radius:14px; padding:22px;
      box-shadow:0 10px 30px rgba(0,0,0,.08);
    }
    .recu h2{margin:0 0 8px; color:var(--ok)}
    .row{margin:10px 0}
    .label{display:inline-block; min-width:180px; color:var(--muted)}
    .hr{height:1px; background:#e5e7eb; margin:14px 0}
    .status{display:inline-flex; gap:8px; padding:6px 12px; border-radius:999px; font-weight:600; font-size:13px}
    .ok{background:#dcfce7; color:#166534}
    .warn{background:#fff7ed; color:#92400e}
    .err{background:#fee2e2; color:#991b1b}
    .actions{display:flex; gap:10px; margin-top:14px}
    .btn{flex:1; padding:10px 14px; border:none; border-radius:8px; cursor:pointer; font-weight:700}
    .btn-primary{background:var(--ok); color:#fff}
    .btn-outline{background:#fff; color:var(--ok); border:2px solid var(--ok)}
    .hidden{display:none !important}

    @media print {
      body { background:#fff; }
      #message, #btnDone { display: none !important; }
      .recu { box-shadow: none; border:1px solid #e5e7eb; }
    }
  </style>
</head>
<body>

  <h1>V√©rification en cours‚Ä¶</h1>
  <div id="message">Merci de patienter quelques secondes‚Ä¶</div>

  <div id="recu" class="recu hidden">
    <h2>üßæ Re√ßu de mont√©e</h2>
    <div id="statusBadge" class="status"></div>
    <div class="hr"></div>

    <div class="row"><span class="label">Taxi immatricul√© :</span> <strong id="immat">‚Äî</strong></div>
    <div class="row"><span class="label">Chauffeur :</span> <strong id="chauffeur">‚Äî</strong></div>
    <div class="row"><span class="label">Date :</span> <span id="date">‚Äî</span></div>
    <div class="row"><span class="label">Heure :</span> <span id="time">‚Äî</span></div>
    <div class="row"><span class="label">Mois de validit√© :</span> <span id="valid">‚Äî</span></div>

    <div class="hr"></div>
    <div id="noteText" style="color:var(--muted)">‚úÖ Vous √™tes bien mont√© dans le taxi.</div>

    <div class="actions">
      <button id="btnPrint" class="btn btn-primary">üñ®Ô∏è T√©l√©charger / Imprimer</button>
      <button id="btnDone"  class="btn btn-outline">Terminer</button>
    </div>
  </div>

  <script>
  (async () => {
    const el = (id) => document.getElementById(id);
    const msg = (t)=> el('message').textContent = t;
    const showReceipt = ()=>{
      el('recu').classList.remove('hidden');
      el('message').classList.add('hidden');
    };
    const hideReceipt = ()=>{
      el('recu').classList.add('hidden');
      el('message').classList.remove('hidden');
    };

    const setBadge = (status)=>{
      const b = el('statusBadge');
      b.className = 'status';
      if (status==='inserted' || status==='ok'){
        b.classList.add('ok');
        b.textContent = status==='inserted' ? 'Enregistr√©' : 'V√©rifi√©';
      } else if (status==='too_soon'){
        b.classList.add('warn');
        b.textContent = 'D√©j√† enregistr√© r√©cemment';
      } else {
        b.classList.add('err');
        b.textContent = 'Erreur';
      }
    };

    // Affiche le re√ßu √† partir de l'objet "receipt" renvoy√© par le backend
    const renderFrom = ({ receipt }) => {
      const immat  = receipt?.voiture?.immatriculation ?? '‚Äî';
      const driver = receipt?.chauffeur?.display
                  || [receipt?.chauffeur?.prenom, receipt?.chauffeur?.nom].filter(Boolean).join(' ')
                  || '‚Äî';

      el('immat').textContent     = immat;
      el('chauffeur').textContent = driver;
      el('date').textContent      = receipt?.date ?? '‚Äî';
      el('time').textContent      = receipt?.time ?? '‚Äî';
      el('valid').textContent     = receipt?.valid_month ?? '‚Äî';
      showReceipt();
    };

    // Anti-refresh : on ne r√©ins√®re pas si l'utilisateur actualise
    if (sessionStorage.getItem('passager_enregistre') === 'true') {
      msg('‚úÖ Vous √™tes d√©j√† enregistr√© (actualisation bloqu√©e).');
      hideReceipt();
      // On n‚Äôaffiche pas le re√ßu ici, car on ne relance pas d‚Äôappel
      // (option : tu peux stocker le dernier "receipt" en sessionStorage si tu veux r√©afficher)
      return;
    }

    // Boutons (pos√©s t√¥t pour √™tre s√ªrs qu‚Äôils soient actifs)
    el('btnPrint').addEventListener('click', () => window.print());
    el('btnDone').addEventListener('click', () => { window.location.href = '/'; });

    try {
      // 1) R√©cup√©rer voiture_id (vid ou voiture_id) dans l'URL
      const qs = new URLSearchParams(location.search);
      const voitureId = qs.get('vid') || qs.get('voiture_id');
      if (!voitureId) { msg('‚ùå Erreur : identifiant de voiture manquant.'); return; }

      // 2) Date / Heure / Mois (au format attendu par ton backend)
      const now = new Date();
      const date = now.toISOString().slice(0,10);
      const heure = now.toTimeString().slice(0,8);
      const mois_validite = date.slice(0,7);

      // 3) UUID persistant pour diff√©rencier les appareils
      const uuid = localStorage.getItem('uuid') || (crypto.randomUUID ? crypto.randomUUID() : `${Date.now()}-${Math.random()}`);
      localStorage.setItem('uuid', uuid);

      // 4) IP (facultatif)
      let ip = null;
      try {
        const ipRes = await fetch('https://api64.ipify.org?format=json');
        const ipJson = await ipRes.json();
        ip = ipJson.ip || null;
      } catch {}

      // 5) V√©rification (check-only) pour respecter la r√®gle des 15 minutes
      msg('V√©rification en cours‚Ä¶');
      const verif = await fetch('/.netlify/functions/add_passager', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ voiture_id: voitureId, date, heure, montant:0, uuid, ip, mois_validite, isCheckOnly:true })
      }).then(r=>r.json());

      if (verif.status === 'too_soon') {
        setBadge('too_soon');
        el('noteText').textContent = '‚è≥ Vous avez d√©j√† scann√© ce taxi il y a moins de 15 minutes.';
        renderFrom({ receipt: verif.receipt });
        sessionStorage.setItem('passager_enregistre','true');
        return;
      }
      if (verif.status !== 'ok') {
        msg('‚ùå Erreur lors de la v√©rification.');
        console.error(verif);
        return;
      }

      // 6) Insertion
      msg('Enregistrement en cours‚Ä¶');
      const ins = await fetch('/.netlify/functions/add_passager', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ voiture_id: voitureId, date, heure, montant:0, uuid, ip, mois_validite, isCheckOnly:false })
      }).then(r=>r.json());

      if (ins.status === 'inserted' || ins.status === 'ok') {
        setBadge(ins.status);
        el('noteText').textContent =
          ins.status === 'inserted' ? '‚úÖ Enregistrement effectu√©.' : '‚úÖ V√©rification effectu√©e.';
        renderFrom({ receipt: ins.receipt || verif.receipt });
        sessionStorage.setItem('passager_enregistre','true');
        return;
      }
      if (ins.status === 'too_soon') {
        setBadge('too_soon');
        el('noteText').textContent = '‚è≥ Vous avez d√©j√† scann√© ce taxi il y a moins de 15 minutes.';
        renderFrom({ receipt: ins.receipt || verif.receipt });
        sessionStorage.setItem('passager_enregistre','true');
        return;
      }

      msg('‚ùå Une erreur est survenue lors de l‚Äôinsertion.');
      console.error(ins);

    } catch (e) {
      console.error(e);
      msg('‚ùå Erreur inattendue. Veuillez r√©essayer.');
    }
  })();
  </script>
</body>
</html>














